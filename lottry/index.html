<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Moon Chat App</title>
  <script type="module">
    // ================= Firebase SDKs =================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, set, push, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ========== Tera Firebase Config ==============
    const firebaseConfig = {
      apiKey: "AIzaSyDE8zApy4owfoFlgrbB80LSCEVxRWAvqcc",
      authDomain: "lalitapp-5cdf0.firebaseapp.com",
      databaseURL: "https://lalitapp-5cdf0-default-rtdb.firebaseio.com",
      projectId: "lalitapp-5cdf0",
      storageBucket: "lalitapp-5cdf0.appspot.com",
      messagingSenderId: "296397903515",
      appId: "1:296397903515:web:efe85353eb8f548243d83e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentChatUser = null;

    // ========== Login ==========
    loginBtn.onclick = () => {
      const email = loginEmail.value;
      const password = loginPassword.value;

      signInWithEmailAndPassword(auth, email, password)
        .then(async (userCred) => {
          currentUser = userCred.user;

          // username generate (before @ from email)
          const emailId = email.split("@")[0];

          // Save user info in DB if not already
          const userRef = ref(db, "users/" + currentUser.uid);
          await set(userRef, {
            username: emailId,
            email: email
          });

          loginDiv.style.display = "none";
          chatDiv.style.display = "block";
          loadUsers();
        })
        .catch(err => alert(err.message));
    };

    // ========== Logout ==========
    logoutBtn.onclick = () => {
      signOut(auth).then(() => {
        currentUser = null;
        chatDiv.style.display = "none";
        loginDiv.style.display = "block";
      });
    };

    // ========== Load Users ==========
    function loadUsers() {
      get(ref(db, "users")).then(snapshot => {
        const usersList = usersDiv;
        usersList.innerHTML = "";
        snapshot.forEach(childSnap => {
          const user = childSnap.val();
          if (childSnap.key !== currentUser.uid) {
            const div = document.createElement("div");
            div.innerText = user.username + " (" + user.email + ")";
            div.className = "userItem";
            div.onclick = () => startChat(childSnap.key, user.username);
            usersList.appendChild(div);
          }
        });
      });
    }

    // ========== Start Private Chat ==========
    function startChat(friendUid, friendName) {
      currentChatUser = friendUid;
      chatWith.innerText = "Chat with: " + friendName;
      messagesDiv.innerHTML = "";

      const chatRoomId = [currentUser.uid, friendUid].sort().join("_");

      get(ref(db, "chats/" + chatRoomId + "/messages")).then(snapshot => {
        messagesDiv.innerHTML = "";
        snapshot.forEach(childSnap => {
          const msg = childSnap.val();
          showMessage(msg.sender, msg.text);
        });
      });

      sendBtn.onclick = () => {
        const text = messageInput.value;
        if (text.trim() === "") return;
        const msgRef = push(ref(db, "chats/" + chatRoomId + "/messages"));
        set(msgRef, {
          sender: currentUser.email,
          text: text
        });
        messageInput.value = "";
      };
    }

    // ========== Show Message ==========
    function showMessage(sender, text) {
      const div = document.createElement("div");
      div.className = sender === currentUser.email ? "myMsg" : "friendMsg";
      div.innerText = sender + ": " + text;
      messagesDiv.appendChild(div);
    }

    // ========== Search User ==========
    searchBtn.onclick = () => {
      const query = searchInput.value.toLowerCase();
      get(ref(db, "users")).then(snapshot => {
        usersDiv.innerHTML = "";
        snapshot.forEach(childSnap => {
          const user = childSnap.val();
          if (user.username.toLowerCase().includes(query) && childSnap.key !== currentUser.uid) {
            const div = document.createElement("div");
            div.innerText = user.username + " (" + user.email + ")";
            div.className = "userItem";
            div.onclick = () => startChat(childSnap.key, user.username);
            usersDiv.appendChild(div);
          }
        });
      });
    };
  </script>

  <style>
    body { font-family: Arial; background: #111; color: white; text-align: center; }
    #chatDiv { display: none; }
    .userItem { background: #222; margin: 5px; padding: 8px; cursor: pointer; border-radius: 8px; }
    .myMsg { background: #4caf50; margin: 5px; padding: 6px; border-radius: 6px; text-align: right; }
    .friendMsg { background: #333; margin: 5px; padding: 6px; border-radius: 6px; text-align: left; }
  </style>
</head>
<body>
  <h1>ðŸŒ™ Moon Chat App</h1>

  <!-- Login only -->
  <div id="loginDiv">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email"><br>
    <input id="loginPassword" type="password" placeholder="Password"><br>
    <button id="loginBtn">Login</button>
  </div>

  <!-- Chat -->
  <div id="chatDiv">
    <button id="logoutBtn">Logout</button>
    <h3 id="chatWith">No chat selected</h3>

    <input id="searchInput" placeholder="Search username...">
    <button id="searchBtn">Search</button>

    <div id="usersDiv"></div>

    <div id="messagesDiv"></div>
    <input id="messageInput" placeholder="Type message...">
    <button id="sendBtn">Send</button>
  </div>
</body>
</html>
